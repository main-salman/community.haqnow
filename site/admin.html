<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin â€” Community HaqNow</title>
    <style>
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif; }
      main { padding: 40px 24px; max-width: 820px; margin: 0 auto; }
      h1 { font-size: 1.5rem; margin: 0 0 16px; }
      form { display: grid; gap: 12px; margin-bottom: 16px; }
      label { font-weight: 600; }
      input, select { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; }
      button { padding: 10px 14px; border-radius: 10px; background: #111827; color: #fff; border: 0; }
      table { border-collapse: collapse; width: 100%; }
      th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
      .error { color: #b91c1c; }
      @media (prefers-color-scheme: dark) {
        input, select { background: #111827; color: #fff; border-color: #374151; }
        button { background: #2563eb; }
        th, td { border-color: #374151; }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Admin</h1>
      <div id="auth"></div>
      <section id="create">
        <h2>Create user</h2>
        <form id="createForm">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" required />
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" type="password" required />
          </div>
          <div>
            <label for="role">Role</label>
            <select id="role">
              <option value="viewer">viewer</option>
              <option value="editor">editor</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <button type="submit">Create</button>
        </form>
        <div class="error" id="error"></div>
      </section>
      <section>
        <h2>Users</h2>
        <table>
          <thead>
            <tr><th>ID</th><th>Email</th><th>Role</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </section>
    </main>
    <script>
      const token = localStorage.getItem('token');
      const authDiv = document.getElementById('auth');
      if (!token) {
        authDiv.innerHTML = '<p class="error">Not authenticated. <a href="/login.html">Login</a></p>';
      }

      async function authedFetch(url, options = {}) {
        const headers = Object.assign({}, options.headers || {}, { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') });
        const res = await fetch(url, Object.assign({}, options, { headers }));
        if (res.status === 401) {
          window.location.href = '/login.html';
          return Promise.reject(new Error('Unauthorized'));
        }
        return res;
      }

      async function loadUsers() {
        const rows = document.getElementById('rows');
        rows.innerHTML = '';
        const res = await authedFetch('/community-api/admin/users');
        if (!res.ok) {
          document.getElementById('error').textContent = 'Failed to load users';
          return;
        }
        const data = await res.json();
        for (const u of (data.users || [])) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.id}</td><td>${u.email}</td><td>${u.role}</td>`;
          rows.appendChild(tr);
        }
      }

      document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;
        const res = await authedFetch('/community-api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, role })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('error').textContent = data.detail || 'Failed to create user';
          return;
        }
        document.getElementById('error').textContent = '';
        e.target.reset();
        loadUsers();
      });

      loadUsers();
    </script>
  </body>
  </html>


